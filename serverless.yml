service: tripiz-nostr-relay
frameworkVersion: "4"

package:
  patterns:
    - "src/**"
  individually: true
  excludeDevDependencies: true

provider:
  name: aws
  runtime: nodejs18.x
  deploymentMethod: "direct"
  region: "ap-northeast-1"
  environment:
    NOSTR_EVENTS_SNS_ARN: ${env:NOSTR_EVENTS_SNS_ARN}
    OPENAI_API_KEY: ${env:OPENAI_API_KEY}
    UPSTASH_REDIS_REST_URL: ${env:UPSTASH_REDIS_REST_URL}
    UPSTASH_REDIS_REST_TOKEN: ${env:UPSTASH_REDIS_REST_TOKEN}
    SALT: ${env:SALT}
    ASTRADB_ENDPOINT: ${env:ASTRADB_ENDPOINT}
    ASTRADB_TOKEN: ${env:ASTRADB_TOKEN}
  iam:
    role:
      managedPolicies:
        - "arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess"
        - "arn:aws:iam::aws:policy/AmazonSNSFullAccess"
        - "arn:aws:iam::aws:policy/AmazonAPIGatewayInvokeFullAccess"

functions:
  persistence:
    name: "persistence"
    handler: "src/subscriber/persistence.handler"
    timeout: 6
    memorySize: 256
    architecture: arm64
    maximumRetryAttempts: 1
    events:
      - sns:
          arn: ${env:NOSTR_EVENTS_SNS_ARN}
  moderation:
    name: "moderation"
    handler: "src/subscriber/moderation.handler"
    timeout: 6
    memorySize: 256
    architecture: arm64
    maximumRetryAttempts: 1
    events:
      - sns:
          arn: ${env:NOSTR_EVENTS_SNS_ARN}
          filterPolicyScope: MessageAttributes
          filterPolicy:
            kind:
              - 1
  embeddings:
    name: "embeddings"
    handler: "src/subscriber/embeddings.handler"
    timeout: 6
    memorySize: 256
    architecture: arm64
    maximumRetryAttempts: 1
    events:
      - sns:
          arn: ${env:NOSTR_EVENTS_SNS_ARN}
          filterPolicyScope: MessageAttributes
          filterPolicy:
            kind:
              - 1
  xray_content:
    name: "xray_content"
    handler: "src/subscriber/xray_content.handler"
    timeout: 30
    memorySize: 256
    architecture: arm64
    maximumRetryAttempts: 1
    events:
      - sns:
          arn: ${env:NOSTR_EVENTS_SNS_ARN}
          filterPolicyScope: MessageAttributes
          filterPolicy:
            kind:
              - 1
  discuss_dreams:
    name: "discuss_dreams"
    handler: "src/subscriber/discuss_dreams.handler"
    timeout: 30
    memorySize: 256
    architecture: arm64
    maximumRetryAttempts: 1
    events:
      - sns:
          arn: ${env:NOSTR_EVENTS_SNS_ARN}
          filterPolicyScope: MessageAttributes
          filterPolicy:
            kind:
              - 1
            category:
              - dreams
  discuss_memories:
    name: "discuss_memories"
    handler: "src/subscriber/discuss_memories.handler"
    timeout: 30
    memorySize: 256
    architecture: arm64
    maximumRetryAttempts: 1
    events:
      - sns:
          arn: ${env:NOSTR_EVENTS_SNS_ARN}
          filterPolicyScope: MessageAttributes
          filterPolicy:
            kind:
              - 1
            category:
              - memories
  discuss_reflections:
    name: "discuss_reflections"
    handler: "src/subscriber/discuss_reflections.handler"
    timeout: 30
    memorySize: 256
    architecture: arm64
    maximumRetryAttempts: 1
    events:
      - sns:
          arn: ${env:NOSTR_EVENTS_SNS_ARN}
          filterPolicyScope: MessageAttributes
          filterPolicy:
            kind:
              - 1
            category:
              - reflections
  relay_event:
    name: "nostr-relay-EVENT"
    handler: "src/router/EVENT.handler"
    timeout: 30
    memorySize: 256
    architecture: arm64
    maximumRetryAttempts: 1
  relay_close:
    name: "nostr-relay-CLOSE"
    handler: "src/router/CLOSE.handler"
    timeout: 30
    memorySize: 256
    architecture: arm64
    maximumRetryAttempts: 1
  relay_req:
    name: "nostr-relay-REQ"
    handler: "src/router/REQ.handler"
    timeout: 30
    memorySize: 256
    architecture: arm64
    maximumRetryAttempts: 1
  relay_default:
    name: "nostr-relay-default"
    handler: "src/router/default.handler"
    timeout: 30
    memorySize: 256
    architecture: arm64
    maximumRetryAttempts: 1
  relay_connect:
    name: "nostr-relay-connect"
    handler: "src/router/connect.handler"
    timeout: 30
    memorySize: 256
    architecture: arm64
    maximumRetryAttempts: 1
  relay_disconnect:
    name: "nostr-relay-disconnect"
    handler: "src/router/disconnect.handler"
    timeout: 30
    memorySize: 256
    architecture: arm64
    maximumRetryAttempts: 1
