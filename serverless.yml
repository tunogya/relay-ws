service: tripiz-nostr-relay
frameworkVersion: "3"
useDotenv: true

package:
  patterns:
    - "src/**"
  individually: true
  excludeDevDependencies: true

provider:
  name: aws
  runtime: nodejs18.x
  deploymentMethod: "direct"
  region: "ap-northeast-1"
  iam:
    role:
      managedPolicies:
        - "arn:aws:iam::aws:policy/AmazonSNSFullAccess"

plugins:
  - "serverless-plugin-typescript"
  - "serverless-dotenv-plugin"

functions:
  persistence:
    name: "nostr-persistence"
    handler: "src/persistence.handler"
    timeout: 6
    memorySize: 256
    architecture: arm64
    maximumRetryAttempts: 1
    events:
      - sns:
          arn: ${env:NOSTR_EVENTS_SNS_ARN}
  moderation:
    name: "nostr-moderation"
    handler: "src/moderation.handler"
    timeout: 6
    memorySize: 256
    architecture: arm64
    maximumRetryAttempts: 1
    events:
      - sns:
          arn: ${env:NOSTR_EVENTS_SNS_ARN}
          filterPolicyScope: MessageAttributes
          filterPolicy:
            kind:
              - 1
  embeddings:
    name: "nostr-embeddings"
    handler: "src/embeddings.handler"
    timeout: 6
    memorySize: 256
    architecture: arm64
    maximumRetryAttempts: 1
    events:
      - sns:
          arn: ${env:NOSTR_EVENTS_SNS_ARN}
          filterPolicyScope: MessageAttributes
          filterPolicy:
            kind:
              - 1
  call_CarlJung:
    name: "nostr-call_CarlJung"
    handler: "src/call_CarlJung.handler"
    timeout: 30
    memorySize: 256
    architecture: arm64
    maximumRetryAttempts: 1
    events:
      - sns:
          arn: ${env:NOSTR_EVENTS_SNS_ARN}
          filterPolicyScope: MessageAttributes
          filterPolicy:
            kind:
              - 1
            category:
              - dreams
  resonance:
    name: "nostr-resonance"
    handler: "src/resonance.handler"
    timeout: 30
    memorySize: 256
    architecture: arm64
    maximumRetryAttempts: 1
    events:
      - sns:
          arn: ${env:NOSTR_EVENTS_SNS_ARN}
          filterPolicyScope: MessageAttributes
          filterPolicy:
            kind:
              - 1
